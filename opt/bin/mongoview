#! /usr/bin/env python3

import argparse
from functools import partial
from pathlib import PurePosixPath

from pymongo import MongoClient, DESCENDING
from tabulate import tabulate

from aftviewer import interactive_cui, ReturnMessage as RM


def get_contents(client, path):
    if str(path) == '.':
        # at root
        dbs = client.list_database_names()
        return sorted(dbs), []
    elif len(path.parents) == 1:
        # database
        db = client[path.name]
        cols = db.list_collection_names()
        ret = []
        for cl in cols:
            if not cl.startswith('system'):
                ret.append(cl)
        return [], sorted(ret)
    # elif len(path.parents) == 2:
    #     # collection
    #     col = client[path.parent.name][path.name]
    else:
        return [], []


def show_func(client, path: str, **kwargs):
    pathes = path.split('/')
    assert len(pathes) == 2, f'path: {path}'
    col = client[pathes[0]][pathes[1]]
    item0 = col.find_one()
    if item0 is None:
        return RM('no items', True)
    keys = list(item0.keys())
    keys.sort()
    if args.max_num <= 0:
        items = col.find()
    else:
        items = col.find().sort('_id', DESCENDING).limit(args.max_num)
    item_table = [[item[k] for k in keys] for item in items]
    table_str = tabulate(item_table, keys, tablefmt='orgtbl')
    return RM(table_str, False)


def main(args):
    client = MongoClient(args.address, args.port)
    gc = partial(get_contents, client)
    sf = partial(show_func, client)
    interactive_cui(args.address, gc, sf, PurePosixPath)


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('address', help='IP address of MongoDB server.')
    parser.add_argument('-p', '--port', help='port number', type=int,
                        default=27017)
    parser.add_argument('-n', '--max_num',
                        help='maximum number of items to get', type=int,
                        default=-1)
    args = parser.parse_args()
    main(args)
